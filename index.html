<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Visualizador 360 — Cubemap & Equiretangular (Three.js)</title>
  <style>
    :root { --bg:#0b0b12; --ink:#e8e8ef; --muted:#9aa0a6; --card:#14141f; --acc:#6ae3ff; }
    html,body {
      margin:0; padding:0; width:100%; height:100%;
      background:var(--bg); color:var(--ink);
      font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans";
      overflow:hidden;
    }
    .app { width:100%; height:100%; }
    header {
      position:absolute; top:0; left:0; right:0;
      display:flex; gap:.75rem; align-items:center;
      padding:.75rem 1rem;
      background:linear-gradient(180deg,#12121b,#0b0b12cc);
      z-index:10;
      border-bottom:1px solid #1f2330;
    }
    header h1 { font-size:14px; margin:0; letter-spacing:.2px; color:var(--muted);}
    .controls { display:flex; flex-wrap:wrap; gap:.5rem 1rem; align-items:center; margin-left:auto;}
    .btn, .file {
      appearance:none; border:1px solid #2b3142; background:var(--card);
      color:var(--ink); border-radius:10px; padding:.55rem .8rem; cursor:pointer;
    }
    .btn:hover { border-color:#3a4157;}
    .seg { display:inline-flex; background:var(--card); border:1px solid #2b3142; border-radius:10px; overflow:hidden;}
    .seg input { display:none; }
    .seg label { padding:.5rem .75rem; cursor:pointer; color:var(--muted); border-right:1px solid #2b3142; }
    .seg label:last-child { border-right:0; }
    .seg input:checked + label { background:#1a1f2d; color:var(--ink); }
    #viewer { position:absolute; top:0; left:0; right:0; bottom:0; }
    canvas { display:block; width:100%; height:100%; }
    .hint {
      position:absolute; left:12px; bottom:12px;
      color:var(--muted); background:rgba(20,20,31,.5);
      padding:.4rem .55rem; border:1px solid #2b3142; border-radius:8px; backdrop-filter: blur(6px);
      font-size:12px;
    }
    .drop {
      position:absolute; inset:0; border:2px dashed #2b3142; border-radius:16px;
      display:none; place-items:center; color:var(--muted); background:rgba(0,0,0,.15);
    }
    .drop.show { display:grid; }
    .kbd {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      background:#111522; padding:0 .35rem; border-radius:6px; border:1px solid #2b3142; color:#cfe1ff;
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>Visualizador 360</h1>
    <div class="seg">
      <input type="radio" id="m-eq" name="mode" value="equirect" checked>
      <label for="m-eq">Equiretangular</label>
      <input type="radio" id="m-cm" name="mode" value="cubemap">
      <label for="m-cm">Cubemap</label>
    </div>
    <input class="file" id="fileEq" type="file" accept="image/*" />
    <input class="file" id="fileCm" type="file" accept="image/*" multiple />
    <button class="btn" id="btnDemoEq">Demo EQ</button>
    <button class="btn" id="btnDemoCm">Demo CM</button>
    <button class="btn" id="btnFS">Fullscreen</button>
  </header>

  <div id="viewer">
    <div class="drop" id="drop">
      <div>
        <div style="font-size:15px; margin-bottom:.25rem;">Solte arquivos aqui</div>
        <div style="font-size:12px;color:#b9beca">Equiretangular: 1 imagem 2:1 • Cubemap: 6 imagens posx/negx/posy/negy/posz/negz</div>
      </div>
    </div>
    <div class="hint">Arraste para girar • Pinça/rolagem para zoom • <span class="kbd">F</span> tela cheia</div>
  </div>
</div>

<!-- Import map -->
<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.159.0/build/three.module.js"
  }
}
</script>

<script type="module">
import * as THREE from "three";
import { OrbitControls } from "https://unpkg.com/three@0.159.0/examples/jsm/controls/OrbitControls.js";

const container=document.getElementById('viewer');
const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
renderer.setSize(window.innerWidth,window.innerHeight);
container.appendChild(renderer.domElement);

const scene=new THREE.Scene();
const camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.1,2000);
camera.position.set(0,0,0.1);

const controls=new OrbitControls(camera,renderer.domElement);
controls.enableDamping=true; controls.enablePan=false;
controls.minDistance=0.05; controls.maxDistance=10;

let sphereMesh=null, skyboxMesh=null, cubeTex=null;

function disposeIf(obj){if(!obj)return;if(obj.isMesh){obj.geometry?.dispose();if(Array.isArray(obj.material))obj.material.forEach(m=>m.dispose());else obj.material?.dispose();scene.remove(obj);}} 
function clearBackground(){if(scene.background?.dispose)scene.background.dispose();scene.background=null;}

async function loadEquirect(fileOrUrl){
  disposeIf(skyboxMesh); skyboxMesh=null; if(cubeTex){cubeTex.dispose();cubeTex=null;} clearBackground();
  if(!sphereMesh){const geom=new THREE.SphereGeometry(500,64,64); geom.scale(-1,1,1); sphereMesh=new THREE.Mesh(geom,new THREE.MeshBasicMaterial()); scene.add(sphereMesh);}
  const tex=await new THREE.TextureLoader().loadAsync(fileOrUrl instanceof File?URL.createObjectURL(fileOrUrl):fileOrUrl);
  tex.colorSpace=THREE.SRGBColorSpace; sphereMesh.material.map=tex; sphereMesh.material.needsUpdate=true; renderOnce();
}

async function loadCubemap(filesOrUrls){
  disposeIf(sphereMesh); sphereMesh=null; clearBackground();
  const faceMap={posx:null,negx:null,posy:null,negy:null,posz:null,negz:null};
  const arr=Array.isArray(filesOrUrls)?filesOrUrls:[filesOrUrls];
  if(arr[0] instanceof File){for(const f of arr){const k=keyFromName(f.name);if(k)faceMap[k]=URL.createObjectURL(f);}}
  else if(typeof arr[0]==="object"){Object.assign(faceMap,arr[0]);}
  if(Object.values(faceMap).some(v=>!v)){alert("Cubemap incompleto");return;}
  cubeTex=await new THREE.CubeTextureLoader().loadAsync([faceMap.posx,faceMap.negx,faceMap.posy,faceMap.negy,faceMap.posz,faceMap.negz]);
  cubeTex.colorSpace=THREE.SRGBColorSpace;
  if(!skyboxMesh){const box=new THREE.BoxGeometry(1000,1000,1000); const shader=THREE.ShaderLib["cube"],uni=THREE.UniformsUtils.clone(shader.uniforms); const mat=new THREE.ShaderMaterial({fragmentShader:shader.fragmentShader,vertexShader:shader.vertexShader,uniforms:uni,depthWrite:false,side:THREE.BackSide}); skyboxMesh=new THREE.Mesh(box,mat); scene.add(skyboxMesh);}
  skyboxMesh.material.uniforms.tCube.value=cubeTex; renderOnce();
}

function keyFromName(n){n=n.toLowerCase();if(n.includes("posx")||n.includes("px"))return"posx";
if(n.includes("negx")||n.includes("nx"))return"negx";if(n.includes("posy")||n.includes("py"))return"posy";
if(n.includes("negy")||n.includes("ny"))return"negy";if(n.includes("posz")||n.includes("pz"))return"posz";
if(n.includes("negz")||n.includes("nz"))return"negz";return null;}

function resize(){const w=window.innerWidth,h=window.innerHeight;camera.aspect=w/h;camera.updateProjectionMatrix();renderer.setSize(w,h);renderOnce();}
window.addEventListener('resize',resize);

function renderOnce(){controls.update();renderer.render(scene,camera);}
(function animate(){requestAnimationFrame(animate);controls.update();renderer.render(scene,camera);})();

// UI
const DEMO_EQ_URL="https://threejs.org/examples/textures/2294472375_24a3b8ef46_o.jpg";
const DEMO_CM_URLS={posx:"https://threejs.org/examples/textures/cube/Bridge2/posx.jpg",negx:"https://threejs.org/examples/textures/cube/Bridge2/negx.jpg",posy:"https://threejs.org/examples/textures/cube/Bridge2/posy.jpg",negy:"https://threejs.org/examples/textures/cube/Bridge2/negy.jpg",posz:"https://threejs.org/examples/textures/cube/Bridge2/posz.jpg",negz:"https://threejs.org/examples/textures/cube/Bridge2/negz.jpg"};

document.getElementById("m-eq").addEventListener("change",()=>loadEquirect(DEMO_EQ_URL));
document.getElementById("m-cm").addEventListener("change",()=>loadCubemap(DEMO_CM_URLS));
document.getElementById("fileEq").addEventListener("change",e=>{if(e.target.files[0])loadEquirect(e.target.files[0]);});
document.getElementById("fileCm").addEventListener("change",e=>{if(e.target.files.length)loadCubemap(Array.from(e.target.files));});
document.getElementById("btnDemoEq").addEventListener("click",()=>loadEquirect(DEMO_EQ_URL));
document.getElementById("btnDemoCm").addEventListener("click",()=>loadCubemap(DEMO_CM_URLS));
document.getElementById("btnFS").addEventListener("click",()=>document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen());
document.addEventListener("keydown",e=>{if(e.key==="f"||e.key==="F")document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen();});

const drop=document.getElementById("drop");
["dragenter","dragover"].forEach(ev=>container.addEventListener(ev,e=>{e.preventDefault();drop.classList.add("show");}));
["dragleave","drop"].forEach(ev=>container.addEventListener(ev,e=>{e.preventDefault();drop.classList.remove("show");}));
container.addEventListener("drop",e=>{const f=[...e.dataTransfer.files];if(f.length===1)loadEquirect(f[0]);else if(f.length>1)loadCubemap(f);});

loadEquirect(DEMO_EQ_URL); resize();
</script>
</body>
</html>
