<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>360 Viewer – Photo Sphere Viewer</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photo-sphere-viewer@5/dist/photo-sphere-viewer.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/gyroscope-plugin@5/dist/index.css">
  <style>
    * { box-sizing: border-box; }
    html, body { height:100%; margin:0; background:#0b0f14; color:#e6edf3; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial; }
    #app { position: fixed; inset: 0; display: grid; grid-template-rows: auto 1fr; }
    header { display:flex; gap:.5rem; align-items:center; padding:.6rem .8rem; background: linear-gradient(180deg, rgba(255,255,255,.04), transparent); border-bottom: 1px solid rgba(255,255,255,.08); }
    header h1 { margin:0; font-size: 1rem; letter-spacing:.2px; font-weight:600; opacity:.9 }
    header .spacer { flex:1 }
    .btn { appearance:none; border:1px solid rgba(255,255,255,.15); background: rgba(255,255,255,.06); color:#e6edf3; padding:.45rem .7rem; border-radius: 999px; cursor:pointer; font-weight:600; font-size:.9rem; transition: .15s ease; }
    .btn:hover { background: rgba(255,255,255,.12); }
    .input { border:1px solid rgba(255,255,255,.15); background: rgba(255,255,255,.06); color:#e6edf3; padding:.45rem .6rem; border-radius: 10px; min-width: 220px; }
    #viewer { position: relative; background:#0b0f14; }
    #dropzone { position:absolute; inset:0; display:none; place-items:center; background: rgba(35, 131, 226, .12); outline: 2px dashed rgba(35,131,226,.8); outline-offset: -12px; z-index: 5; }
    #dropzone p { background: rgba(11,15,20,.8); padding: .6rem .8rem; border-radius: 12px; border:1px solid rgba(255,255,255,.12); }
    .toast { position: fixed; left: 50%; bottom: 16px; transform: translateX(-50%); background: rgba(20,24,31,.9); border:1px solid rgba(255,255,255,.1); padding:.6rem .8rem; border-radius: 10px; font-size:.9rem; display:none; z-index: 10; }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <h1>360 Viewer</h1>
      <div class="spacer"></div>
      <input id="urlInput" class="input" type="url" placeholder="Cole a URL de uma imagem 360 (equiretangular)" />
      <button id="loadUrlBtn" class="btn">Carregar URL</button>
      <label for="fileInput" class="btn" title="Carregar arquivo local">Carregar arquivo…</label>
      <input id="fileInput" type="file" accept="image/*" style="display:none" />
      <button id="gyroBtn" class="btn" title="Usar giroscópio do celular">Ativar Giro</button>
      <button id="resetBtn" class="btn" title="Recentrar visão">Recentrar</button>
    </header>
    <div id="viewer"></div>
  </div>
  <div id="dropzone"><p>Solte uma imagem 360 aqui</p></div>
  <div id="toast" class="toast"></div>

  <!-- Dependências UMD (sem bundler) -->
  <script src="https://cdn.jsdelivr.net/npm/uevent@2/browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/photo-sphere-viewer@5/dist/photo-sphere-viewer.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/gyroscope-plugin@5/dist/index.umd.js"></script>

  <script>
    const dropzone = document.getElementById('dropzone');
    const toast = document.getElementById('toast');
    const container = document.getElementById('viewer');

    // Placeholder equiretangular gerado em runtime
    function placeholderDataURL(){
      const c = document.createElement('canvas');
      c.width = 4096; c.height = 2048;
      const ctx = c.getContext('2d');
      const g = ctx.createLinearGradient(0,0,0,c.height);
      g.addColorStop(0,'#0b0f14'); g.addColorStop(1,'#1b2838');
      ctx.fillStyle = g; ctx.fillRect(0,0,c.width,c.height);
      ctx.fillStyle = 'rgba(255,255,255,.08)';
      for (let x=0; x<c.width; x+=64) ctx.fillRect(x,0,1,c.height);
      for (let y=0; y<c.height; y+=64) ctx.fillRect(0,y,c.width,1);
      ctx.fillStyle = 'rgba(255,255,255,.9)';
      ctx.font = 'bold 96px system-ui, sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('Arraste para olhar', c.width/2, c.height/2 - 40);
      ctx.font = '48px system-ui, sans-serif';
      ctx.fillText('Carregue um arquivo ou cole uma URL', c.width/2, c.height/2 + 30);
      return c.toDataURL('image/png');
    }

    // Inicializa o viewer do Photo Sphere Viewer
    let gyroPlugin = null;
    const Viewer = window.PhotoSphereViewer?.Viewer;
    const GyroNS = window.PhotoSphereViewerGyroscopePlugin || window.PhotoSphereViewer; // fallback de namespace
    const GyroscopePlugin = GyroNS && (GyroNS.GyroscopePlugin || GyroNS.default || GyroNS);

    const psv = new Viewer({
      container,
      panorama: placeholderDataURL(),
      touchmoveTwoFingers: false,
      mousewheel: false,
      defaultZoomLvl: 50,
      caption: 'Carregue uma imagem 360 e arraste para explorar',
      navbar: [
        'zoom', 'move', 'fullscreen', 'autorotate'
      ],
      plugins: GyroscopePlugin ? [ [ GyroscopePlugin, { absolutePosition: true } ] ] : []
    });

    psv.once('ready', () => showToast('Pronto! Use o topo para carregar sua imagem.'));

    // Obtém instância do plugin de giroscópio (se disponível)
    psv.on('plugins-loaded', () => {
      try {
        gyroPlugin = psv.getPlugin(GyroscopePlugin);
      } catch (e) { gyroPlugin = null; }
    });

    // Helpers UI
    function showToast(msg, ms = 2200){
      toast.textContent = msg; toast.style.display = 'block';
      clearTimeout(showToast._t); showToast._t = setTimeout(()=> toast.style.display='none', ms);
    }

    function loadFromURL(url){
      if (!url) return;
      psv.setPanorama(url).then(()=> showToast('Panorama carregado!')).catch((e)=>{
        console.error(e); showToast('Falha ao carregar URL. Verifique o link e CORS.');
      });
    }

    function loadFromFile(file){
      const objectURL = URL.createObjectURL(file);
      psv.setPanorama(objectURL).then(()=>{
        showToast('Panorama carregado!');
        // o PSV faz cache interno, desreferencie depois
        setTimeout(()=> URL.revokeObjectURL(objectURL), 10000);
      }).catch((e)=>{ console.error(e); showToast('Não foi possível ler o arquivo.'); });
    }

    // Drag & Drop
    ['dragenter','dragover'].forEach(ev => document.addEventListener(ev, e => {
      e.preventDefault(); dropzone.style.display = 'grid';
    }));
    ['dragleave','drop'].forEach(ev => document.addEventListener(ev, e => {
      e.preventDefault(); if (ev === 'drop') return; dropzone.style.display = 'none';
    }));
    document.addEventListener('drop', (e) => {
      e.preventDefault(); dropzone.style.display = 'none';
      const file = e.dataTransfer.files && e.dataTransfer.files[0];
      if (file) loadFromFile(file);
    });

    // Botões
    document.getElementById('loadUrlBtn').addEventListener('click', ()=>{
      const url = document.getElementById('urlInput').value.trim();
      loadFromURL(url);
    });
    document.getElementById('fileInput').addEventListener('change', (e)=>{
      const f = e.target.files[0]; if (f) loadFromFile(f); e.target.value='';
    });
    document.getElementById('resetBtn').addEventListener('click', ()=>{
      psv.rotate({ yaw: 0, pitch: 0 }, 500);
    });
    document.getElementById('gyroBtn').addEventListener('click', async ()=>{
      if (!gyroPlugin){ showToast('Giroscópio indisponível neste navegador.'); return; }
      try {
        if (!gyroPlugin.isEnabled()){ await gyroPlugin.start(); showToast('Giroscópio ativado.'); }
        else { gyroPlugin.stop(); showToast('Giroscópio desativado.'); }
      } catch(e){ console.error(e); showToast('Permissão negada ou não suportado.'); }
    });

    // Query param ?src=
    (function initFromQuery(){
      const params = new URLSearchParams(location.search);
      const src = params.get('src');
      if (src) { document.getElementById('urlInput').value = src; loadFromURL(src); }
    })();
  </script>
</body>
</html>
